<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Registrarse - APOLO</title>
  <link rel="stylesheet" href="../css/styles.css">
  <script src="../scripts/config.js"></script>
  <style>
    /* Pequeños ajustes locales para el formulario de registro */
    .form-row {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }
    .form-row .form-group {
      flex: 1;
      margin-bottom: 0; /* El margen lo maneja la fila */
    }
    select {
      width: 100%;
      padding: 14px 16px;
      font-size: 17px;
      border: 1px solid var(--border);
      border-radius: 6px;
      background-color: #fff;
      outline: none;
    }
    /* Animación suave para campos de médico */
    #doctorFields {
      transition: all 0.3s ease-in-out;
      overflow: hidden;
    }
    .legal-text {
      font-size: 11px;
      color: #777;
      margin: 15px 0;
      text-align: left;
    }
  </style>
</head>
<body>

  <div style="width: 100%; max-width: 500px;">
    
    <h1 style="text-align: center; color: var(--primary); margin-bottom: 20px;">APOLO</h1>

    <div class="card">
      <h2 style="margin-top: 0; margin-bottom: 5px;">Crear cuenta nueva</h2>
      <p style="margin: 0 0 20px 0; color: #606770;">Es rápido y fácil.</p>
      
      <div class="separator" style="margin-top: 0;"></div>
      
      <div class="msg" id="msg"></div>

      <form id="signupForm">
        
        <!-- Fila: Nombre y Apellido -->
        <div class="form-row">
          <div class="form-group">
            <input type="text" name="nombre" placeholder="Nombre" required aria-label="Nombre">
          </div>
          <div class="form-group">
            <input type="text" name="apellido" placeholder="Apellido" required aria-label="Apellido">
          </div>
        </div>

        <div class="form-group">
          <input type="email" name="email" placeholder="Correo electrónico" required aria-label="Correo electrónico">
        </div>

        <div class="form-group">
          <input type="password" name="password" placeholder="Contraseña nueva" required aria-label="Contraseña">
        </div>

        <div class="form-group">
          <label style="font-size: 12px; color: #606770; margin-bottom: 4px; display:block;">Fecha de nacimiento</label>
          <input type="date" name="fechaNacimiento" required aria-label="Fecha de nacimiento">
        </div>

        <div class="form-row">
          <div class="form-group">
            <input type="text" name="identificacion" placeholder="Cédula / Identificación" required aria-label="Identificación">
          </div>
          <div class="form-group">
            <input type="tel" name="telefono" placeholder="Teléfono móvil" aria-label="Teléfono">
          </div>
        </div>

        <!-- Selección de Rol -->
        <div class="form-group" style="margin-top: 15px;">
           <label style="font-size: 12px; color: #606770; margin-bottom: 4px; display:block;">¿Quién eres?</label>
           <select name="role" id="roleSelect">
            <option value="paciente" selected>Paciente</option>
            <option value="medico">Médico / Especialista</option>
          </select>
        </div>

        <!-- Campos condicionales para médicos -->
        <div id="doctorFields" style="display:none; background: #f7f8fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px dashed #ccc;">
          <p style="margin: 0 0 10px 0; font-size: 13px; font-weight: bold; color: var(--primary);">Datos Profesionales</p>
          <div class="form-group">
            <input type="text" name="especialidad" id="especialidad" placeholder="Especialidad (ej. Cardiología)">
          </div>
          <div class="form-group">
            <input type="text" name="numeroLicencia" id="numeroLicencia" placeholder="Número de Licencia / Cédula Prof.">
          </div>
        </div>

        <p class="legal-text">
          Al hacer clic en Registrarte, aceptas nuestras Condiciones, la Política de privacidad y la Política de cookies.
        </p>

        <!-- Botón Verde para Registro (Acción de Crear) -->
        <button type="submit" class="btn btn-success" style="width: 100%; margin-top: 10px;">Registrarte</button>
      </form>

      <div style="margin-top: 20px; text-align: center;">
        <a href="login.html" style="text-decoration: none; color: var(--primary); font-size: 15px;">¿Ya tienes una cuenta?</a>
      </div>

    </div>
  </div>

  <script>
    const form = document.getElementById('signupForm');
    const msg = document.getElementById('msg');
    const roleSelect = document.getElementById('roleSelect');
    const doctorFields = document.getElementById('doctorFields');

    // Lógica para mostrar/ocultar campos de médico
    roleSelect.addEventListener('change', () => {
      if (roleSelect.value === 'medico') {
        doctorFields.style.display = 'block';
        // Opcional: enfocar el primer input
        document.getElementById('especialidad').focus();
      } else {
        doctorFields.style.display = 'none';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      msg.textContent = 'Creando cuenta...';
      msg.style.color = '#606770';

      const data = Object.fromEntries(new FormData(form).entries());

      // Validación simple Frontend
      if (data.role === 'medico') {
        if (!data.especialidad || !data.numeroLicencia) {
          msg.textContent = 'Por favor completa tu Especialidad y Nro. de Licencia.';
          msg.style.color = '#dc2626'; // Rojo error
          return;
        }
      }

      try {
        const apiUrl = (window.BACKEND_URL || 'http://localhost:3000') + '/api/signup';
        
        const res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });

        const body = await res.json();

        if (res.ok) {
          msg.textContent = '¡Registro exitoso! Redirigiendo...';
          msg.style.color = '#42b72a'; // Verde éxito
          
          form.reset();
          doctorFields.style.display = 'none';
          
          // Deshabilitar botón para evitar doble envío
          form.querySelector('button').disabled = true;

          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1500);
        } else {
          msg.textContent = body.error || 'Error al registrar el usuario.';
          msg.style.color = '#dc2626';
        }
      } catch (err) {
        console.error(err);
        msg.textContent = 'Error de conexión con el servidor.';
        msg.style.color = '#dc2626';
      }
    });
  </script>
</body>
</html>